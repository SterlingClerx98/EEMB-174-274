---
title: "Chapter 2 problems"
author: "Stephen R. Proulx"
date: "4/4/2020"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
```

## problem 2M1 is to make a grid approximation to estimate the proportion of earth that is land from some new data

Input the data, you could change this by hand, or you could even write some code to simulate it.
```{r input_data}
data=tibble(trial = seq(1,9), outcome=c("W","W","L","W","L","W","W","W","L"))

```

```{r grid_likelihood}
stepsize=0.001
likelhood_tab <- tibble( proportion_water = seq(0,1,stepsize) , likelihood = 0 )
 


ntot=nrow(data)
nwater = nrow(filter(data,outcome=="W"))

likelhood_tab<-mutate(likelhood_tab, likelihood=dbinom(nwater,ntot,proportion_water)) 


ggplot( data=likelhood_tab , aes(x=proportion_water,y=likelihood))+
  geom_point()+
  theme_bw()+ 
  theme( axis.text=element_text(family="Helvetica", size=8,angle=90),text=element_text(family="Helvetica", size=12),legend.position = "none")
        

```


This one uses a prior where only half the parameters have any support
```{r add_bayes}


likelhood_tab<-mutate(likelhood_tab, prior=round(proportion_water)) %>% 
  mutate( unstd.posterior=prior*likelihood) %>%
  mutate( posterior = unstd.posterior/sum(unstd.posterior)) %>% view()


ggplot( data=likelhood_tab , aes(x=proportion_water,y=posterior))+
  geom_point()+
  theme_bw()+ 
  theme( axis.text=element_text(family="Helvetica", size=8,angle=90),text=element_text(family="Helvetica", size=12),legend.position = "none")
        

```


This one uses a uniform prior and sets us up for sampling
```{r add_bayes_uniform}


likelhood_tab<-mutate(likelhood_tab, prior=1) %>% 
  mutate( unstd.posterior=prior*likelihood) %>%
  mutate( posterior = unstd.posterior/sum(unstd.posterior)) 


ggplot( data=likelhood_tab , aes(x=proportion_water,y=posterior))+
  geom_point()+
  theme_bw()+ 
  theme( axis.text=element_text(family="Helvetica", size=8,angle=90),text=element_text(family="Helvetica", size=12),legend.position = "none")
        

```


This is the version listed in the textbook for problems 3E1-7
```{r sample_from_posterior_Rethinking_3.27}
library(rethinking)
p_grid <- seq( from=0 , to=1 , length.out=1000 ) 
prior <- rep( 1 , 1000 )
likelihood <- dbinom( 6 , size=9 , prob=p_grid ) 
posterior <- likelihood * prior
posterior <- posterior / sum(posterior)

set.seed(100)
samplesR <- sample( p_grid , prob=posterior , size=1e4 , replace=TRUE )

```

and some examples of how to report the weight of the posterior distribution
```{r report_probs_Rethinking}
sum( samplesR < 0.2)/1e4


sum( samplesR > 0.8)/1e4

```


Here is the tidyverse version with the series of outcomes (or at least a series compatible with the question). 
```{r sample_tidyversion}
data=tibble(trial = seq(1,9), outcome=c("W","W","L","W","L","W","W","W","L"))

stepsize=0.001
likelhood_tab <- tibble( proportion_water = seq(0,1,stepsize) , likelihood = 0 )
ntot=nrow(data)
nwater = nrow(filter(data,outcome=="W"))
likelhood_tab<-mutate(likelhood_tab, likelihood=dbinom(nwater,ntot,proportion_water)) 
likelhood_tab<-mutate(likelhood_tab, prior= 1) %>% 
  mutate( unstd.posterior=prior*likelihood) %>%
  mutate( posterior = unstd.posterior/sum(unstd.posterior))




samples <- sample( likelhood_tab$proportion_water , prob=likelhood_tab$posterior , size=1e4 , replace=TRUE )
```

```{r p3E1}
sum( samples <0.2 )/length(samples)
```

```{r p3E2}
sum(  samples>0.8 )/length(samples)
```

```{r p3E3}
sum( samples >0.2 & samples<0.8 )/length(samples)

```
```{r p3E4_5}
quantile(samples,c(.2,.8))

```
```{r p3E6}
HPDI(samples, prob = .66)

```

```{r p3E7}
PI(samples, prob = .66)

#same calculation
quantile(samples,c(0.17,.83))


```

```{r p3M1}
data=tibble(trial = seq(1,15), outcome=c("W","W","W","W","W","W","W","W","L","L","L","L","L","L","L"))

stepsize=0.001
likelhood_tab <- tibble( proportion_water = seq(0,1,stepsize) , likelihood = 0 )
ntot=nrow(data)
nwater = nrow(filter(data,outcome=="W"))
likelhood_tab<-mutate(likelhood_tab, likelihood=dbinom(nwater,ntot,proportion_water)) 
likelhood_tab<-mutate(likelhood_tab, prior=1) %>% 
  mutate( unstd.posterior=prior*likelihood) %>%
  mutate( posterior = unstd.posterior/sum(unstd.posterior))


samples <- sample( likelhood_tab$proportion_water , prob=likelhood_tab$posterior , size=1e4 , replace=TRUE )


ggplot( data=likelhood_tab , aes(x=proportion_water,y=posterior))+
  geom_point()+
  theme_bw()+ 
  theme( axis.text=element_text(family="Helvetica", size=8,angle=90),text=element_text(family="Helvetica", size=12),legend.position = "none")
        

```


```{r 3M2}
HPDI(samples, prob=0.9)
```

```{r 3M3}
wpost <- tibble( number_water = rbinom( 1e4 , size = 15 , prob=samples) , real_number = 8 , samples = "posterior") 
wbinom <- tibble( number_water = rbinom(1e4,size=15,prob=8/15) , real_number = 8 , samples = "binomial")

nrow(wpost)
wtot=bind_rows(wpost,wbinom)

ggplot(data=wpost , aes(x=number_water)) + geom_histogram(binwidth=1)
ggplot(data=wbinom , aes(x=number_water)) + geom_histogram(binwidth=1)


ggplot(data=wtot , aes(x=number_water , group=samples, color = samples , fill =samples)) + geom_histogram(binwidth=0.5 ,position="dodge")

```

Here we use the model fit to one dataset to make a "posterior prediction" for a new situation. We calculate the expected frequency of 6/9 waters.
```{r 3M4}

wpost <- tibble( number_water = rbinom(1e4, size = 9 , prob=samples) , real_number = 8 , samples = "posterior") 
nrow(filter(wpost,number_water==6))/nrow(wpost)
```


Now we generate "fake data" using a true probability of water set to 0.7.  You can change the value of "sample_size" to see how much data you need to get a 0.99 PI that is only 1% wide.
```{r 3M6}
sample_size=1e1
ws=rbinom(n=1,size=sample_size,prob=.7)



stepsize=0.0001
likelhood_tab <- tibble( proportion_water = seq(0,1,stepsize) , likelihood = 0 )
ntot=sample_size
nwater = ws
likelhood_tab<-mutate(likelhood_tab, likelihood=dbinom(nwater,ntot,proportion_water)) 
likelhood_tab<-mutate(likelhood_tab, prior=1) %>% 
  mutate( unstd.posterior=prior*likelihood) %>%
  mutate( posterior = unstd.posterior/sum(unstd.posterior))


samples <- sample( likelhood_tab$proportion_water , prob=likelhood_tab$posterior , size=1e4 , replace=TRUE )


PI(samples, prob = .99) 

```
